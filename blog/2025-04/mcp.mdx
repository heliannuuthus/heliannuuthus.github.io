---
slug: OAuth2.1-MCP
title: MCP 身份认证协议
date: 2025-04-30
authors: [heliannuuthus]
tags: [AI]
---

_[MCP（Model Context Protocol）](https://modelcontextprotocol.io) 是一个用于在大模型（LLM）和应用（Application）之间交互的协议，它定义了大模型和应用之间的交互方式，以及大模型和应用之间的上下文传递方式_。统一模型和应用（其实可以视为工具）之间的交互方式，让大模型可以直接使用在线应用来拓展自身能力。
MCP 从去年 10 月左右被提出，起初只有少部分活跃于 AI 开源社区的开发者关注，后续随着 [Manus](https://manus.im) 突然出现，MCP 也逐渐被大众所熟知。\
在最初，是 [Claude](https://claude.ai/download) 真正的将 MCP 集成到自己的应用中，提供了非常强大的用户体验。随后 [Cursor](https://cursor.sh/)、[Cline](https://cline.ai/)、[n8n](https://n8n.io/) 等主流 AI 工具开始搭乘这次东风。\
开发者们开始通过 STDIO 模式将 MCP Server 注册到 MCP Host 中（其实就是一个 python 脚本）。\
随着大量用户涌入社区，社区开始出现 :term[SSE]{./terms/net#sse} 模式的 MCP Server。当前模式下，MCP 可通过 `http` 或 `https` 协议来访问，并使用 :term[SSE]{./terms/net#sse} 协议来传输数据。
在 HTTP 的传统交互模式下，身份和权限是一个老生常谈的问题，在开发者使用 stdio 模式的时候这一点其实并没有很好体现。当企业想要部署可公开（并不是公网可访问）的 MCP Server 时，身份和权限就变得尤为重要。

<!--truncate-->

## 协议内容

> MCP 官方在 [2025-03-26 的规约](https://modelcontextprotocol.io/specification/2025-03-26/basic/authorization) 中提到了 MCP 的身份认证协议，并指出可借助 :term[OAuth 2.1]{./terms/auth#oauth} 使 MCP Client 可以替代用户访问受限的 MCP Server。

:::note

1. 基于 HTTP 的数据传输实现均**应该**符合该规约。
2. STDIO 依赖本地 Python 环境，故而数据传输**不应该**遵循此规范。
3. 在自定义的传输协议中，**必须**遵循对应协议的规约。

:::

协议参考 [OAuth 2.1 IETF Draft](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-01) 声明的最佳实践作为主体框架，\
需要 MCP Server 自行实现 [:ctip[**rfc8414**]{id="OAuth 2.0 Authorization Server Metadata"}](https://datatracker.ietf.org/doc/html/rfc8414) 定义的 `/.well-known/oauth-authorization-server` 端点为 MCP Client 提供认证的*元数据信息*。
当 MCP Client 需要集成多个 MCP Server 时，并不能提前知晓 MCP Server 的认证方式以及*身份服务提供商*，故而 MCP Client 必须支持 [:ctip[**rfc7591**]{id="OAuth 2.0 Dynamic Client Registration Protocol"}](https://datatracker.ietf.org/doc/html/rfc7591) 动态注入能力，这样即可无缝集成多个 MCP Server。

:::nerd

如果 Client 泄漏，那么如何保证 Client 不被其他人冒用呢？\
在 [:ctip[**rfc9700**]{id="Best Current Practice for OAuth 2.0 Security"}](https://datatracker.ietf.org/doc/html/rfc9700#name-insufficient-redirection-ur) 中指出可通过**强校验 Redirect URI** 的手段来保证客户端不会被冒用。

:::

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "issuer": "https://auth.heliannuuthus.com/:client_id",
  "authorization_endpoint": "https://auth.heliannuuthus.com/:client_id/authorize",
  "token_endpoint": "https://auth.heliannuuthus.com/:client_id/token",
  "token_endpoint_auth_methods_supported": [
    "client_secret_basic",
    "private_key_jwt"
  ],
  "token_endpoint_auth_signing_alg_values_supported": [
    "RS256",
    "ES256"
  ],
  "userinfo_endpoint": "https://auth.heliannuuthus.com/userinfo",
  "jwks_uri": "https://auth.heliannuuthus.com/:client_id/jwks.json",
  "registration_endpoint": "https://auth.heliannuuthus.com/register",
  "scopes_supported": [
    "openid",
    "profile",
    "email",
    "address",
    "phone",
    "offline_access"
  ],
  "response_types_supported": [
    "code",
    "code token"
  ],
  "ui_locales_supported": [
    "en-US",
    "en-GB",
    "en-CA",
    "fr-FR",
    "fr-CA"
  ]
}
```

针对 **MCP 身份验证的实现方** 以及 **MCP Client 和 MCP Server** 存在不同的要求。

**MCP 身份验证的实现方** 须满足：

- **必须**为*机密客户端*或者*公开客户端*实施 OAuth2.1 并且遵循最佳安全实践
- **应该**支持 [:ctip[**rfc7591**]{id="OAuth 2.0 Dynamic Client Registration Protocol"}](https://datatracker.ietf.org/doc/html/rfc7591)

**MCP Client 和 MCP Server** 须满足：

- MCP Client **必须**实现 [:ctip[**rfc8414**]{id="OAuth 2.0 Authorization Server Metadata"}](https://datatracker.ietf.org/doc/html/rfc8414)
- MCP Server **应该**支持 [:ctip[**rfc8414**]{id="OAuth 2.0 Authorization Server Metadata"}](https://datatracker.ietf.org/doc/html/rfc7591)

## 授权流程

该节定义在传统 OAuth 流程中如何进行身份认证，以及在\
[服务器元数据发现](#服务器元数据发现) ([:ctip[**rfc8414**]{id="OAuth 2.0 Authorization Server Metadata"}](https://datatracker.ietf.org/doc/html/rfc8414))\
和[客户端动态注册](#客户端动态注册) ([:ctip[**rfc7591**]{id="OAuth 2.0 Dynamic Client Registration Protocol"}](https://datatracker.ietf.org/doc/html/rfc7591))\
不同场景下 MCP Client 和 MCP Server 如何进行身份认证。

### 授权类型

OAuth 定义了多种授权类型，在 OAuth 2.1 中舍弃掉了 `implicit` 和 `password` 类型。MCP 中用到了两种类型：

- :ctip[**authorization_code**]{#授权码模式}: 需要用户登录授权，用于客户端代表用户本身去完成一些操作。
- :ctip[**client_credentials**]{#客户端凭据模式}: 不需要用户登录授权，用于客户端代表自己去做一些*自动化的操作*。

在 MCP Client 未经授权访问受限的 MCP Server 时，MCP Server 应当返回 **401 Unauthorized** 状态码，MCP Client 应当在收到 **401 Unauthorized** 状态码之后主动*发起授权流程*。

### 传统授权

在 :ctip[**rfc9700**]{id="Best Current Practice for OAuth 2.0 Security"} 中声明，公开的客户端（_通常没有应用密钥_）应使用 PKCE 模式发起认证，并且认证服务器应该进行**强制校验**。

```mermaid
sequenceDiagram
    actor UA as User-Agent（浏览器）
    participant Client as 客户端
    participant MCP as MCP 服务器

    Client->>MCP: 未携带 Access Token 发起 MCP 请求
    activate Client
    activate MCP
    MCP-->>Client: HTTP 401 Unauthorized
    deactivate MCP

    Note right of Client: 生成 code_verifier 与 code_challenge

    Client-->>UA: 打开浏览器，携带授权 URL + code_challenge

    UA->>MCP: POST /authorize
    activate UA
    activate MCP

    Note right of MCP: 用户登录并授权

    MCP-->>UA: 重定向至回调 URL，携带授权码
    deactivate MCP
    deactivate UA

    UA-->>Client: 回调携带授权码
    activate Client

    Client->>MCP: 使用 code 与 code_verifier 发送 Token 请求
    activate MCP
    MCP-->>Client: 返回 Access Token（可选 Refresh Token）
    deactivate MCP

    Client->>MCP: 携带 Access Token 发起 MCP 请求
    activate MCP

    Note right of MCP: 开始标准 MCP 消息交换
```

### 服务器元数据发现

> MCP Client **必须支持**获取和解析 [:ctip[**rfc8414**]{id="OAuth 2.0 Authorization Server Metadata"}](https://datatracker.ietf.org/doc/html/rfc8414) 返回的数据，\
> 并且需要实现对应的数据的获取以及授权流程的发起和中转。

- MCP Client 应当在获取 MCP Server 授权元数据时携带 `MCP-Protocol-Version: <protocol-version>` 标头，以声明自己支持的 MCP 认证协议的版本。
- MCP 必须根据 MCP Server URL 来确定 Base URL，方法是丢弃掉 URL 中的路径和查询参数。**一定要确保授权端点始终位于托管 MCP Server 的根域下**。下面是一个例子：
  - `https://auth.heliannuuthus.com/v1/mcp` 为 MCP Server 在 MCP Host 注册的地址
  - 则 Base URL 为 `https://auth.heliannuuthus.com`
  - 服务器元数据端点为：`https://auth.heliannuuthus.com/.well-known/oauth-authorization-server`
- 当没有发现服务器元数据端点时，MCP Client 应当使用默认的端点：
  | Endpoint | 默认路径 | 描述 |
  | ---------------------- | ------------ | --------------------- |
  | authorization_endpoint | `/authorize` | 授权端点 |
  | token_endpoint | `/token` | 令牌端点 |
  | registration_endpoint | `/register` | 注册端点 |
  | userinfo_endpoint | `/userinfo` | 用户信息端点 |
  | jwks_uri | `/jwks` | JSON Web Key Set 端点 |

```mermaid
sequenceDiagram
    participant Client
    participant Server

    Client->>Server: GET /.well-known/oauth-authorization-server
    activate Client
    activate Server

    alt Discovery Success
        Server-->>Client: 200 OK + Metadata Document
        Client->>Client: 使用来自元数据的端点

    else Discovery Failed
        Server-->>Client: 404 Not Found
        deactivate Server
        Client->>Client: 使用默认端点
    end
    Note right of Client: 继续授权流程
    deactivate Client
```

### 客户端动态注册
