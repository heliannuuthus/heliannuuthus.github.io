---
slug: spiffe
title: SPIFFE
authors: [heliannuuthus]
tags: [Cloud]
---

SPIFFE（Secure Production Identity Framework for Everyone），发音：_/ˈspɪfi/_，是一套开源标准，用于解决由于现代网络环境中资源动态变化（如弹性扩缩容、多运行时等）与环境复杂异构（如多云混合架构、跨平台支持等）所带来安全问题。

<!-- truncate -->

import { Collapse } from "@site/src/components/Collapse";

## 概览

### SPIFFE ID

> 本质是:term[统一资源标识符]{./blog/terms/web#uri}，用于标识一个[工作负载](#Workload)

通常格式为：

**_:ctip[spiffe://]{#协议名称，固定前缀}_:ctip[trust-domain]{#信任域，通常是组织的或集群的域名}_:ctip[/path/service-name]{title="工作负载的标识和路径"}_**

:::note

- 需要保证 SPIFFE 是全局唯一的，不能重复
- SPIFFE 相较于 UUID 更具有可读性，更易于人类理解
- 并且也独立于 IP、DNS 等网络底层基础设施

:::

### SVID

> SVID 全称 SPIFFE Verifiable Identity Document，用于验证服务身份的凭证

SVID 通常用于验证[工作负载](#Workload)的身份，有以下两种格式：

- :term[JWT]{./blog/terms/jwt#jwt}：适用于非 TLS 的场景，比如基于 HTTP Header 的认证
- :term[X.509]{./blog/terms/crypto#x509}：适用于 TLS 的场景，比如需要证书的双向认证（mTLS）

并且为了保证安全性，其本身的**_有效时间通常只设置几分钟_**，并且需要**定期更新**。

### Workload

> 工作负载，通常用于标识需要身份的容器、服务或进程 ~与 k8s 的 Deployment 同名~

可以是一个 WebServer、一个数据库、一个消息队列、一个缓存服务等。

## 工作原理

SPIRE（SPIFFE Runtime Environment） 是官方给出的 SPIFFE 规范的一种实现（其他的实现可参考[官方文档](https://spiffe.io)）

### 核心组件

（作为 SVID 颁发机构，管理注册策略并向代理签发 SVID）
（部署在节点上，验证工作负载身份、颁发 SVID 并暴露 SPIFFE 工作负载 API）

SPIRE 由 SPIRE 服务器和多个 SPIRE 代理组成，SPIRE Server 作为颁发 SVID 的颁发机构（也称为签名机构），还维护并管理[工作负载](#Workload)的注册表，SPIRE Agent 通过 SPIRE Server 验证每个工作负载的身份，SPIRE Server 再为其颁发 SVID。
除此之外，SPIRE Agent 为[工作负载](#Workload)公开本地 SPIFFE 工作负载 API，工作负载可通过 SPIFFE 工作负载 API 获取 SVID 并进行身份验证。

#### SPIRE Server

SPIRE Server 由一系列的插件定义，SPIRE 也自己附带了一些插件，但是也能通过构建其他的插件来拓展 SPIRE 应对更多的场景。

- Node Attestor：通常和 SPIRE Agent 一起用于验证[工作负载](#Workload)的节点身份
- DataStore：用于存储[工作负载](#Workload)的注册信息，包括[工作负载](#Workload)注册历史、注册策略等。
- KeyManager：用于控制和管理向[工作负载](#Workload)签发的 SVID（X.509 和 JWT 格式）。
- Upstream Authority：默认情况 SPIRE Server 使用自身的服务器作为 CA，通过定义这个插件可以使用其他的 CA。

#### SPIRE Agent

> **SPIRE Agent**部署通常会部署在每个[工作负载](#Workload)所在的**节点**上，与[工作负载](#Workload)直接通信。

SPIRE Agent 的主要功能：

- 向 SPIRE Server 拉取 SVID 并将其缓存，等待[工作负载](#Workload)主动索要。
- 向节点上的[工作负载](#Workload)公开本地 SPIFFE 工作负载 API，并可证明其身份。
- 为已识别的[工作负载](#Workload)颁发 SVID。

SPIRE Agent 的组件：

- Node Attestor：与 SPIRE Server 的 Node Attestor 插件通信，用于验证[工作负载](#Workload)的节点身份
- Workload Attestor：从工作负载所在的 node 查询[工作负载](#Workload)的注册信息，再结合[工作负载](#Workload)使用注册策略时提交的属性值进行比对来验证工作负载的进程身份。
- Key Manager：生成颁发给[工作负载](#Workload)的 X.509-SVID 的私钥

### SPIRE 组件的互信

> 仅对 k8s_psat 和 x509pop 两种**耐人寻味**的自证方式进行说明

#### k8s_psat

> psat(Projected Service Account Token) 是 k8s 1.12 版本引入的概念，在 1.20 版本稳定的一种新的服务账户令牌，用于替代 sat(Service Account Token)

##### psat 和 sat 的区别

- psat 是在 pod 的 :term[projected volume]{./blog/terms/k8s#projected-volume} 中注入的 sat，可手动声明 audience 以及过期时间（默认 1 小时）等属性
- sat 是 pod 的令牌，在 1.22 之前没有固定过期时间，理论上和 Service Account 生命周期一致，从 1.22 开始，sat 的默认过期时间为 1 年（可调整）。

##### 通信过程

<Collapse label="通信过程">

#### 请求

```http
POST /spire/agent/attest HTTP/1.1
Host: spire-server.example.com
Content-Type: application/json
Content-Length: 1234

{
  "attestation_type": "k8s_psat",
  "attestation_data": "eyJhbGciOiJSUzI1NiIsImtpZCI6IjEyMzQ1Njc4OTAifQ.eyJpc3MiOiJhcGkiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6c3BpcmU6c3BpcmUtYWdlbnQiLCJhdWQiOlsic3BpcmUtc2VydmVyIl0sImV4cCI6MTY3NzY1NDMyMSwiaWF0IjoxNjc3NjU0MDIxLCJrdWJlcm5ldGVzLmlvIjp7Im5hbWVzcGFjZSI6InNwaXJlIiwicG9kIjp7Im5hbWUiOiJzcGlyZS1hZ2VudC14eXoxMjMiLCJ1aWQiOiJhMWIyYzNkNC1lNWY2LTc4OTAtYWJjZC1lZjEyMzQ1Njc4OTAifSwic2VydmljZWFjY291bnQiOnsibmFtZSI6InNwaXJlLWFnZW50In19fQ.signature_here"
}
```

#### 响应

```http
HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: 567

{
  "spiffe_id": "spiffe://<trust_domain>/spire/agent/k8s_psat/<cluster>/<node_UID>",
  "status": "success",
  "message": "Attestation successful"
}
```

```http
POST /spire/agent/svid HTTP/1.1
Host: spire-server.example.com
Content-Type: application/json
Content-Length: 890

{
  "spiffe_id": "spiffe://<trust_domain>/spire/agent/k8s_psat/<cluster>/<node_UID>",
  "csr": "-----BEGIN CERTIFICATE REQUEST-----\nMII...==\n-----END CERTIFICATE REQUEST-----"
}
```

```http
HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: 2345

{
  "svid": {
    "certificate": "-----BEGIN CERTIFICATE-----\nMII...==\n-----END CERTIFICATE-----",
    "ttl": 3600
  },
  "status": "success",
  "message": "SVID issued"
}
```

</Collapse>

#### x509pop

<Collapse label="x509pop">

```http
POST /spire/agent/attest HTTP/1.1
Host: spire-server.example.com
Content-Type: application/json
Content-Length: 1234

{
  "attestation_type": "x509pop",
  "attestation_data": {
    "certificate": "-----BEGIN CERTIFICATE-----\nMIID...==\n-----END CERTIFICATE-----"
  }
}
```

```http
HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: 567

{
  "status": "challenge",
  "challenge": "random-challenge-1234567890"
}
```

```http
POST /spire/agent/attest HTTP/1.1
Host: spire-server.example.com
Content-Type: application/json
Content-Length: 890

{
  "attestation_type": "x509pop",
  "attestation_data": {
    "certificate": "-----BEGIN CERTIFICATE-----\nMIID...==\n-----END CERTIFICATE-----",
    "challenge_response": "signature_of_random-challenge-1234567890"
  }
}
```

```http
HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: 678

{
  "spiffe_id": "spiffe://example.org/spire/agent/x509pop/sha1-fingerprint-abc123",
  "status": "success",
  "message": "Attestation successful"
}
```

```http
POST /spire/agent/svid HTTP/1.1
Host: spire-server.example.com
Content-Type: application/json
Content-Length: 987

{
  "spiffe_id": "spiffe://<trust_domain>/spire/agent/x509pop/<fingerprint>",
  "csr": "-----BEGIN CERTIFICATE REQUEST-----\nMII...==\n-----END CERTIFICATE REQUEST-----"
}
```

```http
HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: 2345

{
  "svid": {
    "certificate": "-----BEGIN CERTIFICATE-----\nMII...==\n-----END CERTIFICATE-----",
    "ttl": 3600
  },
  "status": "success",
  "message": "SVID issued"
}
```

</Collapse>

### 交互流程

```mermaid
sequenceDiagram
    participant SS as SPIRE 服务器
    participant SA as SPIRE 代理
    participant AA as AWS API
    participant Workload as 工作负载

    rect rgb(124, 124, 38)
    SS->>SS: 启动 SPIRE 服务器
    note over SS: 若未配置 Upstream Authority<br>则由 SPIRE Server 自己生成私钥和根证书对后续的 SVID 进行签名<br>否则使用 Upstream Authority 进行签名
    SS->>SS: 生成 CA 证书
    SS->>SS: 创建信任包
    SS->>SS: 启用注册 API，开放工作负载注册
    end

    rect rgb(124, 124, 38)
    SA->>SA: 在 Node 上启动 SPIRE 代理
    note over SA: 例如部署在 AWS 上则使用 AWS 实例身份文档
    SA->>SA: 执行节点证明
    SA->>SS: 通过 TLS 发送证明
    SS->>AA: 调用 AWS API 验证证明
    AA->>SS: 确认文档有效
    note over SS: 可执行额外的证明步骤
    end

    rect rgb(124, 124, 38)
    SS->>SA: 向代理颁发 SVID
    SA->>SS: 请求注册条目（使用 SVID）
    SS->>SS: 使用 SVID 认证代理
    SS->>SA: 发送授权的注册条目
    SA->>SA: 缓存注册条目
    SA->>SA: 发送工作负载 CSR 到服务器
    SS->>SA: 签名并返回工作负载 SVID
    SA->>SA: 缓存工作负载 SVID
    SA->>SA: 开始监听工作负载 API 套接字
    end

    rect rgb(124, 124, 38)
    Workload->>SA: 请求工作负载 SVID
    SA->>SA: 启动工作负载证明
    SA->>SA: 使用工作负载选择器识别工作负载
    SA->>Workload: 返回 SVID（来自缓存）
    end
```
